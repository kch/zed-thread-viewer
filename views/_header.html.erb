<div class="header">
  <div class="type-badge type-<%= type %>">
    <%= type == 'conversation' ? 'TEXT THREAD' : 'AGENT THREAD' %>
  </div>
  <strong><%= CGI.escapeHTML(title) %></strong>
  <button class="star-btn" onclick="toggleHeaderStar()"><%= starred ? '★' : '☆' %></button>
  <button class="copy-btn" onclick="copyTitle()">copy</button>
  <a href="<%= toggle_url %>" class="toggle-link"><%= toggle_text %></a>
</div>

<script>
  function copyTitle() {
    // Call parent window's shared copy function
    if (window.parent && window.parent.copyTitleById) {
      const title = "<%= CGI.escapeHTML(title) %>";
      const id = "<%= id %>";
      window.parent.copyTitleById(title, id);
    }
  }

  function toggleHeaderStar() {
    // Call parent window's shared star function
    if (window.parent && window.parent.toggleStarById) {
      const id = "<%= id %>";
      window.parent.toggleStarById(id);
    }
  }

  // Forward keydown events to parent window for global shortcuts
  document.addEventListener('keydown', (e) => {
    if (window.parent && window.parent.document) {
      // Create a new event in the parent window
      const parentEvent = new window.parent.KeyboardEvent('keydown', {
        key: e.key,
        code: e.code,
        keyCode: e.keyCode,
        which: e.which,
        shiftKey: e.shiftKey,
        ctrlKey: e.ctrlKey,
        altKey: e.altKey,
        metaKey: e.metaKey,
        bubbles: true,
        cancelable: true
      });

      // Dispatch the event on the parent document
      window.parent.document.dispatchEvent(parentEvent);

      // Prevent default in iframe if parent handled it
      if (['c', 'v', 'r', 'j', 'f', '/'].includes(e.key.toLowerCase())) {
        e.preventDefault();
      }
    }
  });
</script>
